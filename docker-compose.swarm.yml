version: '3.8'

services:
  # Aplicação Web Principal
  app:
    image: notleuh/hsrb_sistemas_clinicas:app-latest
    environment:
      - DB_HOST=db
      - DB_NAME=clinica_encaminhamento
      - DB_USER=huelton
      - DB_PASS=123Mudar@
      - BASE_URL=https://clinicas.hueltonsites.com.br
    volumes:
      - uploads_data:/var/www/html/uploads
    networks:
      - rede_production
    depends_on:
      - db
    deploy:
      restart_policy:
        condition: on-failure
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.clinica-app.rule=Host(`clinicas.hueltonsites.com.br`)"
        - "traefik.http.routers.clinica-app.entrypoints=websecure"
        - "traefik.http.routers.clinica-app.tls.certresolver=letsencryptresolver"
        - "traefik.http.services.clinica-app.loadbalancer.server.port=80"

  # API REST para Mobile
  api:
    image: notleuh/hsrb_sistemas_clinicas:api-latest
    environment:
      - DB_HOST=db
      - DB_NAME=clinica_encaminhamento
      - DB_USER=huelton
      - DB_PASS=123Mudar@
      - JWT_SECRET_KEY=sua_chave_secreta_super_forte_aqui_min_32_chars
    networks:
      - rede_production
    depends_on:
      - db
    deploy:
      restart_policy:
        condition: on-failure
      labels:
        - "traefik.enable=true"
        # Rota para /api/*
        - "traefik.http.routers.clinica-api.rule=Host(`clinicas.hueltonsites.com.br`) && PathPrefix(`/api`)"
        - "traefik.http.routers.clinica-api.entrypoints=websecure"
        - "traefik.http.routers.clinica-api.tls.certresolver=letsencryptresolver"
        - "traefik.http.services.clinica-api.loadbalancer.server.port=80"
        # Middleware para remover /api do path (opcional)
        # - "traefik.http.middlewares.api-stripprefix.stripprefix.prefixes=/api"
        # - "traefik.http.routers.clinica-api.middlewares=api-stripprefix"

  # Banco de Dados
  db:
    image: notleuh/hsrb_sistemas_clinicas:db-latest
    environment:
      - MYSQL_ROOT_PASSWORD=123Mudar@
      - MYSQL_DATABASE=clinica_encaminhamento
      - MYSQL_USER=huelton
      - MYSQL_PASSWORD=123Mudar@
    volumes:
      - db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p123Mudar@"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - rede_production
    deploy:
      restart_policy:
        condition: on-failure

volumes:
  db_data:
  uploads_data:

networks:
  rede_production:
    external: true
